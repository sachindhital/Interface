<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Property Insights Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f9fa;
    }
    h2 { color: #2c3e50; margin-bottom: 10px; }
    form {
      display: flex; gap: 10px; align-items: center; margin-bottom: 20px;
    }
    input, select, button { padding: 6px 10px; font-size: 14px; }
    button {
      background-color: #2c3e50; color: white; border: none;
      border-radius: 4px; cursor: pointer;
    }
    button:hover { background-color: #1a252f; }
    .stats {
      background: #eef3ff; padding: 10px 15px; border-radius: 6px;
      width: fit-content; margin-bottom: 15px;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    th { background-color: #f5f5f5; }
    pre {
      background: #f0f0f0; padding: 10px; border-radius: 6px; overflow-x: auto;
    }
    #priceChart, #schoolChart, #popChart, #ageChart, #incomeChart {
      max-width: 400px; max-height: 200px; display: block;
      margin-left: 0; margin-right: auto;
    }
  </style>
</head>

<body>
  <h2>üè° Belmont North Property Insights Dashboard</h2>

  <form method="POST">
    <input type="text" name="suburb" placeholder="Enter suburb" value="{{ suburb }}">
   <select name="endpoint">
  <option value="properties" {% if endpoint == "properties" %}selected{% endif %}>For Sale Properties</option>
  <option value="demographics" {% if endpoint == "demographics" %}selected{% endif %}>Demographics</option>
  <option value="schools" {% if endpoint == "schools" %}selected{% endif %}>Schools</option>
  <option value="amenities" {% if endpoint == "amenities" %}selected{% endif %}>Amenities</option>
  <option value="development" {% if endpoint == "development" %}selected{% endif %}>Development</option>
  <option value="ethnicity" {% if endpoint == "ethnicity" %}selected{% endif %}>Ethnicity</option>
  <option value="pocket" {% if endpoint == "pocket" %}selected{% endif %}>Pocket Prices</option>

</select>

    <button type="submit">Run</button>
  </form>

  <hr>

  {% if error %}
    <p>{{ error }}</p>

  <!-- üè† PROPERTIES -->
  {% elif endpoint == "properties" %}
    <div class="stats">
      <p><strong>Average Price:</strong> ${{ avg_price }}</p>
      <p><strong>Median Bedrooms:</strong> {{ median_bedrooms }}</p>
      <p><strong>Most Common Type:</strong> {{ common_type }}</p>
    </div>

    <div style="width:400px; height:200px;">
      <canvas id="priceChart"></canvas>
    </div>

    <table>
      <tr><th>Address</th><th>Price</th><th>Bedrooms</th><th>Bathrooms</th><th>Type</th></tr>
      {% for p in properties %}
      <tr>
        <td>{{ p.address }}</td>
        <td>${{ "%.0f"|format(p.price) }}</td>
        <td>{{ p["attributes.bedrooms"] }}</td>
        <td>{{ p["attributes.bathrooms"] }}</td>
        <td>{{ p.property_type }}</td>
      </tr>
      {% endfor %}
    </table>

    <script>
      const summary = {{ summary|tojson }};
      new Chart(document.getElementById('priceChart'), {
        type: 'bar',
        data: {
          labels: summary.map(s => s.property_type),
          datasets: [{
            label: 'Average Price by Property Type ($)',
            data: summary.map(s => s.avg_price),
            backgroundColor: 'rgba(54,162,235,0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    </script>

  <!-- üéì SCHOOLS -->
  {% elif endpoint == "schools" %}
    <h3>üéì Schools Data for {{ suburb }}</h3>
    <div style="width:400px; height:200px;">
      <canvas id="schoolChart"></canvas>
    </div>

    <table>
      <tr>
        <th>Name</th><th>Level</th><th>Sector</th><th>Gender</th>
        <th>Attendance Rate</th><th>NAPLAN Rank</th><th>Socioeconomic Rank</th>
      </tr>
      {% for s in schools %}
      <tr>
        <td>{{ s.name }}</td>
        <td>{{ s.school_level_type }}</td>
        <td>{{ s.school_sector_type }}</td>
        <td>{{ s.gender }}</td>
        <td>{{ "%.0f"|format(s.attendance_rate * 100) }}%</td>
        <td>{{ s.naplan_rank }}</td>
        <td>{{ s.socioeconomic_rank }}</td>
      </tr>
      {% endfor %}
    </table>

    <script>
      const schools = {{ schools|tojson }};
      new Chart(document.getElementById('schoolChart'), {
        type: 'bar',
        data: {
          labels: schools.map(s => s.name),
          datasets: [{
            label: 'NAPLAN Score',
            data: schools.map(s => s.naplan),
            backgroundColor: 'rgba(75,192,192,0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 1 } } }
      });
    </script>

      <!-- üß≠ AMENITIES -->
  {% elif endpoint == "amenities" %}
    <h3>üß≠ Amenities in {{ suburb }}</h3>

    <div style="width:400px;height:200px;">
      <canvas id="amenityChart"></canvas>
    </div>

    <table>
      <tr><th>Category</th><th>Name</th><th>Latitude</th><th>Longitude</th></tr>
      {% for a in amenities %}
      <tr>
        <td>{{ a.category }}</td>
        <td>{{ a.name }}</td>
        <td>{{ a.lat }}</td>
        <td>{{ a.lon }}</td>
      </tr>
      {% endfor %}
    </table>

    <script>
      const amenities = {{ summary|tojson }};
      new Chart(document.getElementById('amenityChart'), {
        type: 'pie',
        data: {
          labels: amenities.map(a => a.category),
          datasets: [{
            label: 'Amenity Count',
            data: amenities.map(a => a.count),
            backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    </script>
      <!-- üåè ETHNICITY -->
  {% elif endpoint == "ethnicity" %}
    <h3>üåè Ethnic Composition of {{ suburb }}</h3>

    <div style="width:400px;height:200px;">
      <canvas id="ethnicityChart"></canvas>
    </div>

    <table>
      <tr><th>Ethnicity</th><th>Proportion (%)</th></tr>
      {% for e in ethnicity_data %}
      <tr>
        <td>{{ e.ethnicity }}</td>
        <td>{{ "%.1f"|format(e.proportion * 100) }}%</td>
      </tr>
      {% endfor %}
    </table>

    <script>
      const eth = {{ ethnicity_data|tojson }};
      new Chart(document.getElementById('ethnicityChart'), {
        type: 'pie',
        data: {
          labels: eth.map(e => e.ethnicity),
          datasets: [{
            data: eth.map(e => e.proportion * 100),
            backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1','#ff9da7']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    </script>
      <!-- üí∞ POCKET PRICES -->
  {% elif endpoint == "pocket" %}
    <h3>üí∞ Median Property Prices per Pocket in {{ suburb }}</h3>

    <div style="width:400px;height:200px;">
      <canvas id="pocketChart"></canvas>
    </div>

    <table>
      <tr><th>Property Type</th><th>Average Price ($)</th><th>Average Growth (%)</th></tr>
      {% for p in price_summary %}
      <tr>
        <td>{{ p.property_type }}</td>
        <td>${{ "%.0f"|format(p.avg_price) }}</td>
        <td>{{ "%.2f"|format(p.avg_growth) }}%</td>
      </tr>
      {% endfor %}
    </table>

    <h4>Sample SA1 Area Data (Houses)</h4>
    <table>
      <tr><th>Area</th><th>Value ($)</th><th>Growth (%)</th></tr>
      {% for h in house_data[:10] %}
      <tr>
        <td>{{ h.area_name }}</td>
        <td>${{ "%.0f"|format(h.value) }}</td>
        <td>{% if h.growth is not none %}{{ "%.2f"|format(h.growth) }}{% else %}-{% endif %}%</td>
      </tr>
      {% endfor %}
    </table>

    <script>
      const pocketData = {{ price_summary|tojson }};
      new Chart(document.getElementById('pocketChart'), {
        type: 'bar',
        data: {
          labels: pocketData.map(p => p.property_type),
          datasets: [
            {
              label: 'Average Price ($)',
              data: pocketData.map(p => p.avg_price),
              backgroundColor: 'rgba(75,192,192,0.6)'
            },
            {
              label: 'Average Growth (%)',
              data: pocketData.map(p => p.avg_growth * 100),
              backgroundColor: 'rgba(255,159,64,0.6)',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Price ($)' } },
            y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Growth (%)' } }
          }
        }
      });
    </script>

      <!-- üèóÔ∏è DEVELOPMENT -->
  {% elif endpoint == "development" %}
    <h3>üèóÔ∏è Development Applications in {{ suburb }}</h3>

    <div style="width:400px;height:200px;">
      <canvas id="devChart"></canvas>
    </div>

    <table>
      <tr><th>Date</th><th>Address</th><th>Category</th><th>Description</th></tr>
      {% for d in development %}
      <tr>
        <td>{{ d.date }}</td>
        <td>{{ d.area_name }}</td>
        <td>{{ d.category }}</td>
        <td>{{ d.description }}</td>
      </tr>
      {% endfor %}
    </table>

    <script>
      const devData = {{ summary|tojson }};
      new Chart(document.getElementById('devChart'), {
        type: 'bar',
        data: {
          labels: devData.map(d => d.category),
          datasets: [{
            label: 'Number of Developments',
            data: devData.map(d => d.count),
            backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc948','#b07aa1']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });
    </script>


  <!-- üë®‚Äçüë©‚Äçüëß‚Äçüë¶ DEMOGRAPHICS -->
  {% elif endpoint == "demographics" %}
    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Demographics for {{ suburb }}</h3>

    <div style="display:flex; flex-wrap:wrap; gap:30px;">
      <div style="width:400px;height:200px;">
        <h4>Population Trend</h4>
        <canvas id="popChart"></canvas>
      </div>
      <div style="width:400px;height:200px;">
        <h4>Age Distribution</h4>
        <canvas id="ageChart"></canvas>
      </div>
      <div style="width:400px;height:200px;">
        <h4>Income Distribution</h4>
        <canvas id="incomeChart"></canvas>
      </div>
    </div>

    <script>
      const pop = {{ pop_summary|tojson }};
      const ages = {{ age_summary|tojson }};
      const income = {{ income_summary|tojson }};

      // Population Trend (Line)
      new Chart(document.getElementById('popChart'), {
        type: 'line',
        data: {
          labels: pop.map(p => new Date(p.date).getFullYear()),
          datasets: [{
            label: 'Population',
            data: pop.map(p => p.value),
            borderColor: 'rgba(75,192,192,1)',
            fill: false,
            tension: 0.3
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      // Age Distribution (Bar)
      new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
          labels: ages.map(a => a.age),
          datasets: [{
            label: 'Proportion (%)',
            data: ages.map(a => a.proportion * 100),
            backgroundColor: 'rgba(54,162,235,0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });

      // Income Distribution (Pie)
      new Chart(document.getElementById('incomeChart'), {
        type: 'pie',
        data: {
          labels: income.map(i => i.income_bracket),
          datasets: [{
            data: income.map(i => i.proportion * 100),
            backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    </script>

  <!-- FALLBACK -->
  {% else %}
    <h3>{{ endpoint|capitalize }} Data for {{ suburb }}</h3>
    {% if rawdata %}
      <pre>{{ rawdata|tojson(indent=2) }}</pre>
    {% else %}
      <p>No data found for this suburb.</p>
    {% endif %}
  {% endif %}
</body>
</html>
